<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priest Modern and Techy</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* Light indigo background */
            color: #1f2937;
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #eef2ff; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a5b4fc; }

        /* Custom style for the media container to handle video/image display */
        .media-container {
            height: 250px; /* Fixed height for consistent card size */
            background-color: #1f2937; /* Dark background for media */
        }
        .media-container img, .media-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <!-- Main Application Container -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        
        <!-- Header & Navigation -->
        <header class="flex flex-col sm:flex-row justify-between items-center pb-6 border-b-4 border-indigo-200 mb-8 bg-white p-4 rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-4 sm:mb-0 flex items-center">
                <!-- Icon for presentation -->
                <svg class="w-8 h-8 mr-3 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1v-3.25M7 10h10a2 2 0 012 2v8a2 2 0 01-2 2H7a2 2 0 01-2-2v-8a2 2 0 012-2zM12 4v1m-4 10h8m-8 4h8"></path></svg>
                Priest <span class="text-gray-900 ml-2">Modern & Techy</span>
            </h1>
            <div class="flex space-x-3">
                <button onclick="state.changePage('home')" id="home-btn"
                    class="px-5 py-2 text-base font-medium rounded-xl transition duration-150 ease-in-out bg-indigo-600 hover:bg-indigo-700 text-white shadow-xl">
                    Shop Home
                </button>
                <button onclick="showAdminPasswordPrompt()" id="admin-btn"
                    class="px-5 py-2 text-base font-medium rounded-xl transition duration-150 ease-in-out bg-gray-300 hover:bg-gray-400 text-gray-800 shadow-xl">
                    Admin Access
                </button>
            </div>
        </header>

        <!-- Main Content Area (Rendered by JavaScript) -->
        <div id="content-area">
            <!-- Content will be rendered here by JS based on state.currentPage -->
        </div>

        <!-- FOOTER SECTION -->
        <footer class="mt-16 pt-8 pb-4 border-t-4 border-indigo-200 bg-white rounded-t-xl shadow-inner">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                    <!-- 1. Company Info -->
                    <div class="col-span-2 md:col-span-1">
                        <h3 class="text-xl font-bold text-indigo-700 mb-4">Priest Modern & Techy</h3>
                        <p class="text-sm text-gray-600">Your destination for the latest in footwear and smart devices, blending modern style with cutting-edge technology.</p>
                    </div>

                    <!-- 2. Contact -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Contact Us</h3>
                        <ul class="space-y-2">
                            <li>
                                <a href="https://wa.me/${state.seller.whatsapp.replace('+', '')}" target="_blank" class="text-sm text-gray-600 hover:text-green-600 transition duration-150 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.35 4.96l-1.4 5.17 5.3-1.37c1.47.8 3.12 1.25 4.66 1.25 5.46 0 9.91-4.45 9.91-9.91s-4.45-9.91-9.91-9.91zM17.43 15.65c-.27.7-.75 1.33-1.32 1.83-.58.5-1.28.88-2.02 1.1-.76.22-1.55.33-2.34.33-1.57 0-3.04-.5-4.22-1.47-.85-.68-1.55-1.56-2.06-2.61-.51-1.05-.78-2.19-.78-3.37 0-1.72.63-3.31 1.76-4.52.88-.93 2.05-1.63 3.37-1.99s2.77-.37 4.09.07c.92.3 1.76.84 2.45 1.58.7.73 1.19 1.58 1.48 2.51.29.93.36 1.94.21 2.94-.15 1.05-.53 2.05-1.12 2.91zm-4.32-.88c.24-.2.43-.45.54-.73s.19-.58.19-.9-.06-.57-.19-.85-.3-.5-.54-.7-.52-.36-.83-.48-.65-.18-.98-.18c-.35 0-.7.06-1.05.18s-.65.28-.9.48-.43.45-.54.73-.19.58-.19.9.06.57.19.85s.3.5.54.7.52.36.83.48.65.18.98.18c.35 0 .7-.06 1.05-.18s.65-.28.9-.48z"/></svg>
                                    WhatsApp
                                </a>
                            </li>
                            <li>
                                <a href="mailto:${state.seller.email}" target="_blank" class="text-sm text-gray-600 hover:text-red-600 transition duration-150 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26c.74.49 1.63.49 2.37 0L21 8m-1 10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2h12a2 2 0 012 2v10z"></path></svg>
                                    Email
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- 3. Follow Us -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Follow Us</h3>
                        <ul class="space-y-2">
                            <li>
                                <a href="${state.seller.instagram}" target="_blank" class="text-sm text-gray-600 hover:text-pink-600 transition duration-150 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8a4 4 0 10-8 0 4 4 0 008 0zm0 0v12h-8V8a8 8 0 1116 0zM19 8h.01M6.5 21a.5.5 0 11-1 0 .5.5 0 011 0zM17.5 3a.5.5 0 11-1 0 .5.5 0 011 0z"></path></svg>
                                    Instagram
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- 4. Quick Links (Placeholder) -->
                    <div class="hidden md:block">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Links</h3>
                        <ul class="space-y-2">
                            <li><button onclick="state.changePage('home')" class="text-sm text-gray-600 hover:text-indigo-600 transition duration-150">Shop Items</button></li>
                            <li><a href="#connect" class="text-sm text-gray-600 hover:text-indigo-600 transition duration-150">Seller Contact</a></li>
                        </ul>
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t border-gray-200 text-center">
                    <p class="text-sm text-gray-500">&copy; ${new Date().getFullYear()} Priest Modern and Techy. All rights reserved.</p>
                </div>
            </div>
        </footer>

        <!-- Utility Modals (Always hidden by default) -->
        <div id="modal-container">
            
            <!-- Admin Password Modal -->
            <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
                <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm transform transition duration-300 scale-100">
                    <h3 class="text-2xl font-bold mb-4 text-indigo-700">Admin Login</h3>
                    <p class="text-gray-600 mb-4">Enter the administrator password to manage shop settings and inventory.</p>
                    <input type="password" id="admin-password-input" placeholder="Enter Password"
                        class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4">
                    <div class="flex justify-end space-x-3">
                        <button onclick="hideAdminPasswordPrompt()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancel</button>
                        <button onclick="attemptAdminLogin()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">Login</button>
                    </div>
                    <p id="password-error" class="text-red-500 mt-3 text-sm hidden font-medium"></p>
                </div>
            </div>

            <!-- Buy/Contact Modal (UPDATED TO INCLUDE INSTAGRAM) -->
            <div id="buy-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
                <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition duration-300 scale-100">
                    <h3 class="text-2xl font-extrabold mb-4 text-green-700">Purchase Inquiry!</h3>
                    <p class="text-gray-700 mb-6">You are inquiring about: **<span id="buy-item-name" class="font-bold text-gray-900"></span>**. Please use one of the methods below to finalize your order directly with the seller.</p>
                    
                    <div class="space-y-4">
                        <!-- WhatsApp Link -->
                        <a id="whatsapp-link" target="_blank" class="flex items-center p-4 bg-green-100 border-2 border-green-300 rounded-xl hover:bg-green-200 transition duration-150 shadow-md cursor-pointer">
                            <svg class="w-8 h-8 text-green-600 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.35 4.96l-1.4 5.17 5.3-1.37c1.47.8 3.12 1.25 4.66 1.25 5.46 0 9.91-4.45 9.91-9.91s-4.45-9.91-9.91-9.91zm4.72 13.59c-.27.7-.75 1.33-1.32 1.83-.58.5-1.28.88-2.02 1.1-.76.22-1.55.33-2.34.33-1.57 0-3.04-.5-4.22-1.47-.85-.68-1.55-1.56-2.06-2.61-.51-1.05-.78-2.19-.78-3.37 0-1.72.63-3.31 1.76-4.52.88-.93 2.05-1.63 3.37-1.99s2.77-.37 4.09.07c.92.3 1.76.84 2.45 1.58.7.73 1.19 1.58 1.48 2.51.29.93.36 1.94.21 2.94-.15 1.05-.53 2.05-1.12 2.91zm-4.32-.88c.24-.2.43-.45.54-.73s.19-.58.19-.9-.06-.57-.19-.85-.3-.5-.54-.7-.52-.36-.83-.48-.65-.18-.98-.18c-.35 0-.7.06-1.05.18s-.65.28-.9.48-.43.45-.54.73-.19.58-.19.9.06.57.19.85s.3.5.54.7.52.36.83.48.65.18.98.18c.35 0 .7-.06 1.05-.18s.65-.28.9-.48z"/></svg>
                            <span class="font-bold text-lg">WhatsApp: <span class="text-gray-900">${state.seller.whatsapp}</span></span>
                        </a>
                        
                        <!-- Email Link -->
                        <a id="email-link" target="_blank" class="flex items-center p-4 bg-red-100 border-2 border-red-300 rounded-xl hover:bg-red-200 transition duration-150 shadow-md cursor-pointer">
                            <svg class="w-8 h-8 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26c.74.49 1.63.49 2.37 0L21 8m-1 10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2h12a2 2 0 012 2v10z"></path></svg>
                            <span class="font-bold text-lg">Email: <span class="text-gray-900">${state.seller.email}</span></span>
                        </a>

                        <!-- Instagram Link (NEW) -->
                        <a id="instagram-link" target="_blank" class="flex items-center p-4 bg-pink-100 border-2 border-pink-300 rounded-xl hover:bg-pink-200 transition duration-150 shadow-md cursor-pointer">
                            <svg class="w-8 h-8 text-pink-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8a4 4 0 10-8 0 4 4 0 008 0zm0 0v12h-8V8a8 8 0 1116 0zM19 8h.01M6.5 21a.5.5 0 11-1 0 .5.5 0 011 0zM17.5 3a.5.5 0 11-1 0 .5.5 0 011 0z"></path></svg>
                            <span class="font-bold text-lg">Send a DM on Instagram</span>
                        </a>
                    </div>

                    <div class="flex justify-end mt-6">
                        <button onclick="hideBuyModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-150">Close</button>
                    </div>
                </div>
            </div>

            <!-- Notification/Message Box (for alerts) -->
            <div id="notification-box" class="fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-xl shadow-xl hidden z-50 transition-transform transform duration-300 ease-out font-semibold">
                <p id="notification-message"></p>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports (MUST be type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // --- Global Variables and Firebase Initialization ---
        
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth, storage;
        
        // State management object
        window.state = {
            currentPage: 'home', 
            isAuthenticated: false, // Firebase Auth state
            isAdminLoggedIn: false, // Manual password check state 
            isAuthReady: false,
            userId: null,
            products: [], 
            // Welcome message to reflect "techy gadgets"
            welcomeMessage: 'Discover the latest shoes and techy gadgets. Modernity meets technology right here.', 
            
            // Seller contact details (Fixed as per user request)
            seller: {
                whatsapp: '+27692459852',
                email: 'nemutambwenoble38@gmail.com',
                instagram: 'https://www.instagram.com/b.i.g_priest?igsh=MWJydWV2dXN6am8wMg=='
            },
            
            changePage: function(page) {
                // Check if admin page is being accessed without being logged in via password
                if (page === 'admin' && !this.isAdminLoggedIn) { 
                    showNotification("Please log in with the Admin password first.", 'bg-yellow-600');
                    window.showAdminPasswordPrompt(); // Use window scope
                    return;
                }
                this.currentPage = page;
                renderApp();
            }
        };

        async function initializeFirebase() {
            setLogLevel('Debug');
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                // 1. Authenticate user
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        state.userId = user.uid;
                        state.isAuthenticated = true;
                    } else {
                        // Sign in using custom token or anonymously
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Authentication failed, attempting anonymous sign-in.", e);
                            await signInAnonymously(auth);
                        }
                    }
                    
                    state.isAuthReady = true;
                    
                    // 2. Start data listeners once auth is ready
                    if (db) {
                        setupProductListener();
                        setupConfigListener();
                    }
                    
                    // 3. Initial render
                    renderApp();
                });
            } catch (e) {
                console.error("Failed to initialize Firebase:", e);
                showNotification("Error: Could not connect to the database or storage.", 'bg-red-600');
                state.isAuthReady = true;
                renderApp();
            }
        }
        
        // --- Firestore Utilities ---

        function getPublicItemsCollection() {
            return collection(db, `artifacts/${appId}/public/data/items`);
        }
        
        // Use a static path for the admin config so it doesn't rely on the anonymous user's UID
        function getAdminConfigDoc() {
            return doc(db, `artifacts/${appId}/public/data/shop_config/main`); 
        }

        // --- Real-Time Data Listeners ---

        function setupProductListener() {
            try {
                const q = query(getPublicItemsCollection());
                onSnapshot(q, (snapshot) => {
                    const products = [];
                    snapshot.forEach((doc) => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    state.products = products.sort((a, b) => b.timestamp - a.timestamp); 
                    renderApp();
                }, (error) => {
                    console.error("Error listening to products:", error);
                    showNotification("Error fetching products: " + error.message, 'bg-red-600');
                });
            } catch (e) {
                console.error("Failed to set up product listener:", e);
            }
        }

        function setupConfigListener() {
            try {
                const configRef = getAdminConfigDoc();
                onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        state.welcomeMessage = data.welcomeMessage || state.welcomeMessage;
                    } else {
                        // Initialize default welcome message if it doesn't exist
                        setDoc(configRef, { welcomeMessage: state.welcomeMessage });
                    }
                    renderApp();
                }, (error) => {
                    console.error("Error listening to config:", error);
                });
            } catch (e) {
                console.error("Failed to set up config listener:", e);
            }
        }
        
        // --- Firebase Storage Upload Function ---

        async function uploadFilesAndGetUrls(files, productId) {
            const urls = [];
            let uploadCount = 0;
            const totalFiles = files.length;
            
            for (const file of files) {
                uploadCount++;
                const fileExtension = file.name.split('.').pop();
                const storagePath = `products/${productId}/${crypto.randomUUID()}.${fileExtension}`;
                const fileRef = ref(storage, storagePath);

                showNotification(`Uploading file ${uploadCount} of ${totalFiles}...`, 'bg-indigo-600');

                try {
                    const snapshot = await uploadBytes(fileRef, file);
                    const downloadUrl = await getDownloadURL(snapshot.ref);
                    urls.push(downloadUrl);
                } catch (e) {
                    console.error(`Error uploading file ${file.name}:`, e);
                    // Continue trying other files, but notify the user
                    showNotification(`Failed to upload ${file.name}. Continuing with others...`, 'bg-yellow-600');
                }
            }
            return urls;
        }


        // --- Admin Functions ---

        async function handleNewItemPost(event) {
            event.preventDefault();
            const form = event.target;

            const categoryValue = form.category.value; // Get category
            const priceValue = parseFloat(form.price.value);
            
            // Check for 'Techy' or 'Shoe'
            if (categoryValue !== 'Shoe' && categoryValue !== 'Techy') {
                 showNotification("Please select a valid category (Shoe or Techy).", 'bg-red-600');
                 return;
            }

            if (isNaN(priceValue) || priceValue <= 0) {
                 showNotification("Price must be a valid positive number.", 'bg-red-600');
                 return;
            }
            
            // --- FILE UPLOAD LOGIC ---
            const files = form.mediaFiles.files;
            
            if (files.length === 0) {
                 showNotification("Please select at least one picture or video to upload.", 'bg-red-600');
                 return;
            }

            if (!storage) {
                showNotification("Storage service is not initialized. Please refresh.", 'bg-red-600');
                return;
            }

            const itemId = crypto.randomUUID();
            const mediaUrls = await uploadFilesAndGetUrls(files, itemId);
            
            if (mediaUrls.length === 0) {
                showNotification("No media files were successfully uploaded. Item not posted.", 'bg-red-600');
                return;
            }
            // -----------------------------

            const newItem = {
                name: form.name.value.trim(),
                description: form.description.value.trim(),
                mediaUrls: mediaUrls,
                condition: form.condition.value,
                currency: form.currency.value,
                price: priceValue,
                category: categoryValue, // Can be 'Shoe' or 'Techy'
                timestamp: Date.now()
            };

            if (!newItem.name || !newItem.description) {
                showNotification("Please fill in all required text fields.", 'bg-red-600');
                return;
            }

            try {
                // Use setDoc with the generated ID for easy reference/deletion later
                await setDoc(doc(getPublicItemsCollection(), itemId), newItem); 
                form.reset();
                showNotification("Item posted successfully!", 'bg-green-600');
            } catch (e) {
                console.error("Error adding document: ", e);
                showNotification("Error posting item: " + e.message, 'bg-red-600');
            }
        }
        
        // Make this function globally accessible for onclick in Admin Panel
        window.updateWelcomeMessage = async function() {
            const newMsg = document.getElementById('welcome-message-input').value.trim();
            if (!newMsg) {
                 showNotification("Welcome message cannot be empty.", 'bg-red-600');
                 return;
            }
            if (!state.isAdminLoggedIn) {
                showNotification("Admin privilege required to save configuration.", 'bg-red-600');
                return;
            }
            
            const configRef = getAdminConfigDoc();
            try {
                await setDoc(configRef, { welcomeMessage: newMsg }, { merge: true });
                showNotification("Home page updated successfully!", 'bg-green-600');
            } catch (e) {
                console.error("Error updating config:", e);
                showNotification("Error updating home page: " + e.message, 'bg-red-600');
            }
        }
        
        // --- Product Card Media Cycling Logic ---
        window.cycleMedia = function(itemId, direction) {
            const card = document.querySelector(`[data-item-id="${itemId}"]`);
            if (!card) return;

            // Retrieve data from card attributes
            const mediaList = JSON.parse(card.getAttribute('data-media-urls').replace(/&quot;/g, '"'));
            const mediaCount = mediaList.length;
            if (mediaCount <= 1) return;

            const mediaContainer = card.querySelector('.media-container');
            let mediaElement = card.querySelector('.current-media');
            const indexSpan = card.querySelector('.media-index-span');
            let currentIndex = parseInt(card.getAttribute('data-current-index') || 0);

            // Calculate new index (wrap around)
            currentIndex += direction;
            if (currentIndex >= mediaCount) {
                currentIndex = 0;
            } else if (currentIndex < 0) {
                currentIndex = mediaCount - 1;
            }
            
            // Update elements
            const newUrl = mediaList[currentIndex];
            const isVideo = newUrl.match(/\.(mp4|webm|ogg)$/i);
            
            // Use innerHTML to fully replace the content
            if (isVideo) {
                 mediaContainer.innerHTML = `
                    <video class="current-media" controls autoplay muted loop
                        onerror="this.outerHTML='<img class=current-media src=\\'https://placehold.co/600x400/374151/ffffff?text=Video+Unavailable\\' alt=\\'Video Unavailable\\'>'"
                        src="${newUrl}"></video>
                 `;
            } else {
                 mediaContainer.innerHTML = `
                    <img class="current-media" 
                        onerror="this.onerror=null; this.src='https://placehold.co/600x400/374151/ffffff?text=Media+Unavailable'; this.alt='Media Unavailable';"
                        alt="Product Image ${currentIndex + 1}" src="${newUrl}">
                 `;
            }

            // Re-inject controls and index span after innerHTML replacement
            // Find the category badge to correctly style the index counter
            const conditionBadge = card.querySelector('.condition-badge');
            const conditionClass = conditionBadge ? conditionBadge.classList.contains('bg-indigo-600') ? 'bg-indigo-600' : 'bg-green-600' : 'bg-gray-600';

            mediaContainer.insertAdjacentHTML('beforeend', `
                <span class="absolute top-3 left-3 px-3 py-1 text-xs font-bold rounded-full text-white bg-black bg-opacity-50 media-index-span">${currentIndex + 1}/${mediaCount}</span>
                <span data-condition="${conditionBadge.dataset.condition}" class="absolute top-3 right-3 px-3 py-1 text-xs font-bold rounded-full text-white shadow-md ${conditionClass} condition-badge">${conditionBadge.dataset.condition.toUpperCase()}</span>
                <div class="absolute inset-0 flex items-center justify-between opacity-100 transition duration-300">
                    <button onclick="event.stopPropagation(); cycleMedia('${itemId}', -1)" 
                        class="p-2 ml-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-80 transition shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <button onclick="event.stopPropagation(); cycleMedia('${itemId}', 1)" 
                        class="p-2 mr-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-80 transition shadow-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            `);
            
            card.setAttribute('data-current-index', currentIndex);
        }

        // --- UI Rendering Functions ---
        
        function updateAdminButton() {
            const adminBtn = document.getElementById('admin-btn');
            if (adminBtn) {
                if (state.isAdminLoggedIn) {
                    adminBtn.textContent = 'Admin Dashboard';
                    adminBtn.onclick = () => state.changePage('admin');
                    // Styling for logged-in admin
                    adminBtn.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
                    adminBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white');
                } else {
                    adminBtn.textContent = 'Admin Access';
                    adminBtn.onclick = window.showAdminPasswordPrompt;
                    // Styling for non-logged-in admin
                    adminBtn.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
                    adminBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'text-white');
                }
            }
        }
        
        function renderApp() {
            const contentArea = document.getElementById('content-area');
            if (!contentArea) return;

            if (!state.isAuthReady) {
                contentArea.innerHTML = renderLoadingScreen();
            } else {
                switch (state.currentPage) {
                    case 'home':
                        contentArea.innerHTML = renderHomePage();
                        break;
                    case 'admin':
                        contentArea.innerHTML = renderAdminPanel();
                        // Attach event listener for the post form once rendered
                        const form = document.getElementById('new-item-form');
                        if(form) form.addEventListener('submit', handleNewItemPost);
                        break;
                    default:
                        contentArea.innerHTML = renderHomePage();
                }
            }
            // Always update the admin button state on every render
            updateAdminButton(); 
        }
        
        function renderLoadingScreen() {
             return `
                <div class="flex flex-col items-center justify-center py-20 bg-white rounded-xl shadow-lg">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500 mb-4"></div>
                    <p class="text-xl text-gray-600 font-semibold">Loading shop data...</p>
                </div>
            `;
        }
        
        function createItemCard(item) {
            const currencySymbol = (c) => c === 'Rands' ? 'R' : '$';
            const mediaUrls = item.mediaUrls || [];
            const firstMediaUrl = mediaUrls[0];
            const mediaCount = mediaUrls.length;
            
            // JSON.stringify mediaUrls and escape quotes for the data attribute
            const mediaUrlsString = JSON.stringify(mediaUrls).replace(/"/g, '&quot;');

            const isVideo = firstMediaUrl && firstMediaUrl.match(/\.(mp4|webm|ogg)$/i);
            const mediaTag = isVideo 
                ? `<video class="current-media" controls autoplay muted loop 
                    onerror="this.outerHTML='<img class=current-media src=\\'https://placehold.co/600x400/374151/ffffff?text=Video+Unavailable\\' alt=\\'Video Unavailable\\'>'" 
                    src="${firstMediaUrl}"></video>`
                : `<img class="current-media" src="${firstMediaUrl}" 
                    onerror="this.onerror=null; this.src='https://placehold.co/600x400/374151/ffffff?text=Media+Unavailable'; this.alt='Media Unavailable';"
                    alt="${item.name}">`;
            
            return `
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden transition duration-300 hover:shadow-2xl hover:scale-[1.01] border border-indigo-100"
                    data-item-id="${item.id}"
                    data-media-urls='${mediaUrlsString}'
                    data-current-index="0"
                >
                    <!-- Media Display (Updated for Carousel) -->
                    <div class="media-container relative group">
                        <!-- Image/Video Element (URL updated by cycleMedia) -->
                        ${mediaTag}
                        
                        <!-- Condition Badge (Always visible) -->
                        <span data-condition="${item.condition}" class="absolute top-3 right-3 px-3 py-1 text-xs font-bold rounded-full text-white shadow-md condition-badge
                            ${item.condition === 'New' ? 'bg-indigo-600' : 'bg-green-600'}">
                            ${item.condition.toUpperCase()}
                        </span>

                        <!-- Carousel Controls and Index (Only show if multiple images exist) -->
                        ${mediaCount > 1 ? `
                            <!-- Media Index Counter -->
                            <span class="absolute top-3 left-3 px-3 py-1 text-xs font-bold rounded-full text-white bg-black bg-opacity-50 media-index-span">
                                1/${mediaCount}
                            </span>
                            
                            <!-- Carousel Controls -->
                            <div class="absolute inset-0 flex items-center justify-between opacity-100 transition duration-300">
                                <button onclick="event.stopPropagation(); cycleMedia('${item.id}', -1)" 
                                    class="p-2 ml-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-80 transition shadow-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <button onclick="event.stopPropagation(); cycleMedia('${item.id}', 1)" 
                                    class="p-2 mr-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-80 transition shadow-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"></path></svg>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="p-5">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${item.name}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-3 h-12">${item.description}</p>
                        
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-3xl font-extrabold text-indigo-700">
                                ${currencySymbol(item.currency)}${item.price.toLocaleString()}
                            </span>
                        </div>

                        <button onclick="showBuyModal('${item.name}')" 
                            class="w-full py-3 bg-green-500 text-white rounded-xl font-bold text-lg hover:bg-green-600 transition duration-150 shadow-lg transform hover:scale-[1.02]">
                            BUY NOW
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderItemsSection(title, items) {
            const itemsHtml = items.length > 0
                ? items.map(createItemCard).join('')
                : `<p class="col-span-full text-center py-8 text-xl text-gray-500 bg-white rounded-xl shadow-inner border border-gray-100">No ${title.toLowerCase()} available yet. Check back soon!</p>`;
            
            // Determine header border color based on category title
            const borderColorClass = title.includes('Techy') ? 'border-purple-400' : 'border-emerald-400';

            return `
                <section class="mb-12">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2 ${borderColorClass}">
                        ${title}
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                        ${itemsHtml}
                    </div>
                </section>
            `;
        }

        function renderHomePage() {
            // Filter products by category
            const techyGadgets = state.products.filter(p => p.category === 'Techy');
            const shoes = state.products.filter(p => p.category === 'Shoe');
            
            // Use 'Techy Gadgets' for the section title
            const techySection = renderItemsSection('Techy Gadgets', techyGadgets);
            const shoesSection = renderItemsSection('Modern Shoes', shoes);
            
            return `
                <!-- Welcome Message & CTA -->
                <section class="mb-12 text-center bg-indigo-50 p-10 rounded-2xl shadow-2xl border-4 border-indigo-200">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight mb-4">${state.welcomeMessage}</h2>
                    <p class="text-xl text-indigo-700 font-medium">Find the perfect blend of style and innovation for your life.</p>
                </section>
                
                <!-- Product Grid - Techy Gadgets -->
                ${techySection}

                <!-- Product Grid - Shoes -->
                ${shoesSection}
                
                <!-- Connect Section -->
                <section id="connect" class="bg-white p-10 rounded-2xl shadow-2xl border-2 border-gray-200">
                    <h2 class="text-3xl font-extrabold text-indigo-800 mb-8 text-center">Get Connected</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        
                        <!-- Instagram -->
                        <a href="${state.seller.instagram}" target="_blank" class="block p-6 bg-pink-50 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.03] border-2 border-pink-200">
                            <svg class="w-10 h-10 text-pink-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8a4 4 0 10-8 0 4 4 0 008 0zm0 0v12h-8V8a8 8 0 1116 0zM19 8h.01M6.5 21a.5.5 0 11-1 0 .5.5 0 011 0zM17.5 3a.5.5 0 11-1 0 .5.5 0 011 0z"></path></svg>
                            <span class="font-bold text-xl text-gray-900">Follow on Instagram</span>
                            <p class="text-base text-pink-600 mt-1">b.i.g_priest</p>
                        </a>

                        <!-- WhatsApp -->
                        <a href="https://wa.me/${state.seller.whatsapp.replace('+', '')}" target="_blank" class="block p-6 bg-green-50 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.03] border-2 border-green-200">
                            <svg class="w-10 h-10 text-green-600 mx-auto mb-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.35 4.96l-1.4 5.17 5.3-1.37c1.47.8 3.12 1.25 4.66 1.25 5.46 0 9.91-4.45 9.91-9.91s-4.45-9.91-9.91-9.91zm4.72 13.59c-.27.7-.75 1.33-1.32 1.83-.58.5-1.28.88-2.02 1.1-.76.22-1.55.33-2.34.33-1.57 0-3.04-.5-4.22-1.47-.85-.68-1.55-1.56-2.06-2.61-.51-1.05-.78-2.19-.78-3.37 0-1.72.63-3.31 1.76-4.52.88-.93 2.05-1.63 3.37-1.99s2.77-.37 4.09.07c.92.3 1.76.84 2.45 1.58.7.73 1.19 1.58 1.48 2.51.29.93.36 1.94.21 2.94-.15 1.05-.53 2.05-1.12 2.91zm-4.32-.88c.24-.2.43-.45.54-.73s.19-.58.19-.9-.06-.57-.19-.85-.3-.5-.54-.7-.52-.36-.83-.48-.65-.18-.98-.18c-.35 0-.7.06-1.05.18s-.65.28-.9.48-.43.45-.54.73-.19.58-.19.9.06.57.19.85s.3.5.54.7.52.36.83.48.65.18.98.18c.35 0 .7-.06 1.05-.18s.65-.28.9-.48z"/></svg>
                            <span class="font-bold text-xl text-gray-900">Message on WhatsApp</span>
                            <p class="text-base text-green-600 mt-1">${state.seller.whatsapp}</p>
                        </a>

                        <!-- Email -->
                        <a href="mailto:${state.seller.email}" target="_blank" class="block p-6 bg-red-50 rounded-xl shadow-lg hover:shadow-xl transition duration-300 transform hover:scale-[1.03] border-2 border-red-200">
                            <svg class="w-10 h-10 text-red-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26c.74.49 1.63.49 2.37 0L21 8m-1 10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2h12a2 2 0 012 2v10z"></path></svg>
                            <span class="font-bold text-xl text-gray-900">Send an Email</span>
                            <p class="text-base text-red-600 mt-1">${state.seller.email}</p>
                        </a>
                    </div>
                </section>
            `;
        }
        
        function renderAdminPanel() {
            if (!state.isAdminLoggedIn) {
                return `<div class="p-10 text-center text-red-500 bg-white rounded-xl shadow-lg">Please log in with the correct password to view the Admin Dashboard.</div>`;
            }
            
            return `
                <div class="flex justify-between items-center mb-8 border-b pb-4 border-indigo-300">
                    <h2 class="text-4xl font-extrabold text-gray-800">Admin Dashboard</h2>
                    <p class="text-sm text-gray-500 font-mono bg-gray-100 p-2 rounded-lg">User ID: ${state.userId ? state.userId.substring(0, 8) + '...' : 'N/A'}</p>
                </div>

                <!-- Section 1: Edit Home Page Message -->
                <section class="mb-10 p-8 bg-white rounded-2xl shadow-xl border border-gray-100">
                    <h3 class="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        Edit Home Page Content
                    </h3>
                    <label for="welcome-message-input" class="block text-sm font-medium text-gray-700 mb-2">Shop Welcome Message / Slogan</label>
                    <textarea id="welcome-message-input" rows="3"
                        class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 text-lg"
                        placeholder="Enter the main message visitors see on your homepage.">${state.welcomeMessage}</textarea>
                    
                    <button onclick="updateWelcomeMessage()"
                        class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition duration-150 shadow-md">
                        Save Home Message
                    </button>
                </section>

                <!-- Section 2: Post New Item -->
                <section class="p-8 bg-white rounded-2xl shadow-xl border border-gray-100">
                    <h3 class="text-2xl font-bold text-indigo-700 mb-6 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Post New Product
                    </h3>
                    <form id="new-item-form" class="space-y-6">
                        
                        <!-- Name and Description -->
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                            <input type="text" id="name" name="name" required
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500" placeholder="e.g., Nike Air Max 270 or iPhone 15">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="description" name="description" rows="3" required
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500" placeholder="Detailed product description..."></textarea>
                        </div>

                        <!-- Media Files -->
                        <div>
                            <label for="mediaFiles" class="block text-sm font-medium text-gray-700 mb-1">Upload Pictures/Videos (Multiple allowed)</label>
                            <input type="file" id="mediaFiles" name="mediaFiles" multiple accept="image/*,video/*" required
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 bg-white">
                        </div>

                        <!-- CATEGORY SELECTION -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Product Category</label>
                            <div class="flex space-x-6 p-3 border-2 border-gray-300 rounded-lg">
                                <label class="flex items-center">
                                    <input type="radio" name="category" value="Shoe" checked class="form-radio text-indigo-600 h-5 w-5">
                                    <span class="ml-2 text-gray-700 font-medium">Shoe</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="category" value="Techy" class="form-radio text-indigo-600 h-5 w-5">
                                    <span class="ml-2 text-gray-700 font-medium">Techy Gadget</span>
                                </label>
                            </div>
                        </div>

                        <!-- Price, Currency, and Condition in Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            
                            <!-- Price -->
                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price Amount</label>
                                <input type="number" step="0.01" id="price" name="price" required
                                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500">
                            </div>

                            <!-- Currency -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                                <div class="flex space-x-4 p-3 border-2 border-gray-300 rounded-lg h-full items-center">
                                    <label class="flex items-center">
                                        <input type="radio" name="currency" value="Rands" checked class="form-radio text-indigo-600 h-5 w-5">
                                        <span class="ml-2 text-gray-700 font-medium">Rands (R)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="currency" value="USD" class="form-radio text-indigo-600 h-5 w-5">
                                        <span class="ml-2 text-gray-700 font-medium">USD ($)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Condition -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                                <div class="flex space-x-4 p-3 border-2 border-gray-300 rounded-lg h-full items-center">
                                    <label class="flex items-center">
                                        <input type="radio" name="condition" value="New" checked class="form-radio text-indigo-600 h-5 w-5">
                                        <span class="ml-2 text-gray-700 font-medium">New</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="condition" value="Old" class="form-radio text-indigo-600 h-5 w-5">
                                        <span class="ml-2 text-gray-700 font-medium">Old</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit"
                            class="w-full py-3 bg-green-600 text-white rounded-xl font-bold text-lg hover:bg-green-700 transition duration-150 shadow-lg mt-6">
                            POST ITEM TO SHOP
                        </button>
                    </form>
                </section>
            `;
        }
        
        // --- Modal & Utility Functions (Made global for HTML onclick access) ---

        function showNotification(message, bgColorClass) {
            const box = document.getElementById('notification-box');
            const msgEl = document.getElementById('notification-message');
            
            box.className = `fixed bottom-4 right-4 text-white p-4 rounded-xl shadow-xl z-50 transition-transform transform duration-300 ease-out ${bgColorClass}`;
            msgEl.textContent = message;
            box.style.transform = 'translateY(0)';
            box.classList.remove('hidden');

            setTimeout(() => {
                box.style.transform = 'translateY(150%)';
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        window.showAdminPasswordPrompt = function() {
            // If already logged in, just go to admin page
            if (state.isAdminLoggedIn) {
                state.changePage('admin');
                return;
            }
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-modal').classList.add('flex');
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('admin-password-input').value = '';
        }

        window.hideAdminPasswordPrompt = function() {
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('password-modal').classList.remove('flex');
        }

        window.attemptAdminLogin = function() {
            const input = document.getElementById('admin-password-input');
            const error = document.getElementById('password-error');
            const password = input.value.trim();
            const correctPassword = "Apollo3023"; // The password known to the user

            if (password === correctPassword) {
                state.isAdminLoggedIn = true; 
                window.hideAdminPasswordPrompt();
                state.changePage('admin'); 
                showNotification("Welcome Admin! Access granted.", 'bg-indigo-600');
            } else {
                error.textContent = "Incorrect password. Access denied.";
                error.classList.remove('hidden');
                input.value = '';
            }
        }
        
        window.showBuyModal = function(itemName) {
            document.getElementById('buy-item-name').textContent = itemName;
            
            // Set dynamic links for the customer using the fixed seller details
            document.getElementById('whatsapp-link').href = `https://wa.me/${state.seller.whatsapp.replace('+', '')}?text=I'm%20interested%20in%20buying%20your%20${encodeURIComponent(itemName)}.`;
            document.getElementById('email-link').href = `mailto:${state.seller.email}?subject=Inquiry%20about%20${encodeURIComponent(itemName)}`;
            // SETTING INSTAGRAM LINK
            document.getElementById('instagram-link').href = state.seller.instagram;

            document.getElementById('buy-modal').classList.remove('hidden');
            document.getElementById('buy-modal').classList.add('flex');
        }

        window.hideBuyModal = function() {
            document.getElementById('buy-modal').classList.add('hidden');
            document.getElementById('buy-modal').classList.remove('flex');
        }


        // --- Start Application ---
        
        window.onload = initializeFirebase;

    </script>
</body>
</html>
